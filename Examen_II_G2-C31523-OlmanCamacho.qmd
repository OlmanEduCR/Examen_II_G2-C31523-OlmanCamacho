---
title: "Examen_II_G2-C31523-OlmanCamacho"
author: "Olman Camacho"
format: html
editor: visual
---

# Pregunta 1 Cargar el Archivo y librerias
```{r}
library(tidyverse)
library(openxlsx)
moras <- read.xlsx("moras para R.xlsx")
```

# Pregunta 2
```{r}
moras %>%
  summarise(
    MINIMO = min(SALARIO, na.rm = TRUE),
    Q1 = quantile(SALARIO, 0.25, na.rm = TRUE),
    MEDIANA = median(SALARIO, na.rm = TRUE),
    Q3 = quantile(SALARIO, 0.75, na.rm = TRUE),
    MAXIMO = max(SALARIO, na.rm = TRUE),
    PROMEDIO = mean(SALARIO, na.rm = TRUE)
  )

moras %>%
  summarise(
    MINIMO = min(EDAD, na.rm = TRUE),
    Q1 = quantile(EDAD, 0.25, na.rm = TRUE),
    MEDIANA = median(EDAD, na.rm = TRUE),
    Q3 = quantile(EDAD, 0.75, na.rm = TRUE),
    MAXIMO = max(EDAD, na.rm = TRUE),
    PROMEDIO = mean(EDAD, na.rm = TRUE)
  )
```

# Pregunta 3
```{r}
## Z-Score de Salario
zscore_Salario <- abs((moras$SALARIO - mean(moras$SALARIO, na.rm = TRUE)) /
              sd(moras$SALARIO, na.rm = TRUE))

zscore_Edad <- abs((moras$EDAD - mean(moras$EDAD, na.rm = TRUE)) /
              sd(moras$EDAD, na.rm = TRUE))

moras <- moras %>%
  mutate(
    Z_Score_Salario = case_when(
      is.na(zscore_Salario) ~ "FALTANTE",
      zscore_Salario > 1.96 ~ "ATÍPICO",
      TRUE ~ "NO ATÍPICO"
    ),
    Z_Score_Edad = case_when(
      is.na(zscore_Edad) ~ "FALTANTE",
      zscore_Edad > 1.96 ~ "ATÍPICO",
      TRUE ~ "NO ATÍPICO"
  )
)
moras
```

# Pregunta 4
```{r}
colMeans(is.na(moras)) * 100
```

# Pregunta 5
```{r}
## Calcular la moda para imputar los categóricos
calcular_moda <- function(x) {
  frecuencias <- table(x)
  moda <- names(frecuencias)[which.max(frecuencias)]
}
## Imputar SALARIO con la media
moras <- moras %>%
  mutate(
    SALARIO_IMPUTADO = if_else(
      is.na(SALARIO),
      mean(SALARIO, na.rm = TRUE),
      SALARIO
    )
  )

## Imputar EDAD con la media
moras <- moras %>%
  mutate(
    EDAD_IMPUTADO = if_else(
      is.na(EDAD),
      mean(EDAD, na.rm = TRUE),
      EDAD
    )
  )

## Imputar TIPO_ASEGURAMIENTO con la media
moras <- moras %>%
  mutate(
    TIPO_ASEGURAMIENTO_IMPUTADO = if_else(
      is.na(TIPO_ASEGURAMIENTO),
      calcular_moda(TIPO_ASEGURAMIENTO),
      TIPO_ASEGURAMIENTO
    )
  )
moras
```

# Pregunta 6
```{r}
## Gráfico SEXO
moras %>%
  count(SEXO) %>%
  ggplot(aes(x = SEXO, y = n)) +
  geom_col(fill = "#8027F5") +
  geom_text(aes(label = n),
            size = 4) +
  labs(title = "Distribución de SEXO", x = "SEXO", y = "Cantidad de individuos")
### Se observan más individuos de género Masculino que femenino, en la muestra

## Gráfico SECTOR
moras %>%
  count(SECTOR) %>%
  ggplot(aes(x = SECTOR, y = n)) +
  geom_col(fill = "#8027F5") +
  geom_text(aes(label = n),
            size = 4) +
  labs(title = "Distribución de SECTOR", x = "SECTOR", y = "Cantidad de individuos")
### Según la muestra hay más individuos del sector Privado que del sector Público.					
					
## Gráfico INDICADOR.EXTRANJERO
moras %>%
  count(INDICADOR.EXTRANJERO) %>%
  ggplot(aes(x = INDICADOR.EXTRANJERO, y = n)) +
  geom_col(fill = "#8027F5") +
  geom_text(aes(label = n),
            size = 4) +
  labs(title = "Distribución de INDICADOR.EXTRANJERO", x = "INDICADOR.EXTRANJERO", y = "Cantidad de individuos")
### La muestra refleja más individuos nacionales, en comparación con los individuos extranjeros.					
					
## Gráfico TIPO_ASEGURAMIENTO_IMPUTADO
moras %>%
  count(TIPO_ASEGURAMIENTO_IMPUTADO) %>%
  ggplot(aes(x = TIPO_ASEGURAMIENTO_IMPUTADO, y = n)) +
  geom_col(fill = "#8027F5") +
  geom_text(aes(label = n),
            size = 4) +
  labs(title = "Distribución de TIPO_ASEGURAMIENTO_IMPUTADO", x = "TIPO_ASEGURAMIENTO_IMPUTADO", y = "Cantidad de individuos") +
  coord_flip()
### Observe que la categoría de "Convenios Especiales De Asegurados Voluntarios" es la categoría que menos individuos posee la menor cantidad en comparación con "Asalariado", que acapara más del 50% de los datos.					
					
## Gráfico INDICADOR_ACTIVO
moras %>%
  count(INDICADOR_ACTIVO) %>%
  ggplot(aes(x = INDICADOR_ACTIVO, y = n)) +
  geom_col(fill = "#8027F5") +
  geom_text(aes(label = n),
            size = 4) +
  labs(title = "Distribución de INDICADOR_ACTIVO", x = "INDICADOR_ACTIVO", y = "Cantidad de individuos")
### En la muestra se observan más individuos que poseen el seguro activo, en comparación con los que no lo tienen.					
					
## Gráfico INDICADOR_MOROSO
moras %>%
  count(INDICADOR_MOROSO) %>%
  ggplot(aes(x = INDICADOR_MOROSO, y = n)) +
  geom_col(fill = "#8027F5") +
  geom_text(aes(label = n),
            size = 4) +
  labs(title = "Distribución de INDICADOR_MOROSO", x = "INDICADOR_MOROSO", y = "Cantidad de individuos")
### En la muestra se observan menos individuos en condición de morosidad en contraste con los individuos que no tienen deudas.
```

# Pregunta 7
```{r}
## Gráfico SEXO-INDICADOR_MOROSO
moras %>%
  count(SEXO, INDICADOR_MOROSO) %>%
  group_by(SEXO) %>%
  mutate(pct = n / sum(n) * 100) %>%
  ggplot(aes(x = SEXO, y = pct, fill = INDICADOR_MOROSO)) +
  geom_col(position = "fill") +
  labs(
    title = "Relación entre SEXO y Morosidad",
    x = "Categoría",
    y = "Porcentaje",
    fill = "Moroso"
  )
### Según el gráfico relacionado al género, se puede observar que tanto en hombres como en mujeres, el porcentaje de personas morosas es baja, de hecho no alcanza ni el 20% de la muestra. Cabe recalcar que en el total de datos, la mayor cantidad de individuos morosos son hombres. Podemos determinar, en esta muestra, que el género no exhibe una conexión notable con la situación de morosidad.

## Gráfico TIPO_ASEGURAMIENTO-INDICADOR_MOROSO
moras %>%
  count(TIPO_ASEGURAMIENTO_IMPUTADO, INDICADOR_MOROSO) %>%
  group_by(TIPO_ASEGURAMIENTO_IMPUTADO) %>%
  mutate(pct = n / sum(n) * 100) %>%
  ggplot(aes(x = TIPO_ASEGURAMIENTO_IMPUTADO, y = pct, fill = INDICADOR_MOROSO)) +
  geom_col(position = "fill") +
  labs(
    title = "Relación entre TIPO_ASEGURAMIENTO y Morosidad",
    x = "Categoría",
    y = "Porcentaje",
    fill = "Moroso"
  ) +
  coord_flip()
### Según el gráfico relacionado al tipo de aseguramiento, se puede observar que el seguro de Asalariado contiene la mayor parte de los individuos morosos. Sin embargo, a su vez, este mismo seguro contiene mucho más de la mitad de los individuos que son no morosos. Podemos determinar, en esta muestra, que el tipo de aseguramiento no exhibe una conexión siginificativa con la situación de morosidad.

## Gráfico SECTOR-INDICADOR_MOROSO
moras %>%
  count(SECTOR, INDICADOR_MOROSO) %>%
  group_by(SECTOR) %>%
  mutate(pct = n / sum(n) * 100) %>%
  ggplot(aes(x = SECTOR, y = pct, fill = INDICADOR_MOROSO)) +
  geom_col(position = "fill") +
  labs(
    title = "Relación entre SECTOR y Morosidad",
    x = "Categoría",
    y = "Porcentaje",
    fill = "Moroso"
  )
### Según el gráfico relacionado al sector, se puede observar que tanto en el sector público como en el sector privado, el porcentaje de personas morosas es baja, de hecho no alcanza ni el 20% de la muestra. Cabe recalcar que en el total de datos, la mayor cantidad de individuos morosos pertenecen al sector privado. Podemos determinar, en esta muestra, que el sector no exhibe una relación consistente con la situación de morosidad.

## Gráfico INDICADOR_ACTIVO-INDICADOR_MOROSO
moras %>%
  count(INDICADOR_ACTIVO, INDICADOR_MOROSO) %>%
  group_by(INDICADOR_ACTIVO) %>%
  mutate(pct = n / sum(n) * 100) %>%
  ggplot(aes(x = INDICADOR_ACTIVO, y = pct, fill = INDICADOR_MOROSO)) +
  geom_col(position = "fill") +
  labs(
    title = "Relación entre INDICADOR_ACTIVO y Morosidad",
    x = "Categoría",
    y = "Porcentaje",
    fill = "Moroso"
  )
### Según el gráfico relacionado al estado del seguro, se puede observar que tanto los seguros activos como los seguros inactivos el porcentaje de individuos morosos es baja, de hecho no alcanza ni el 20% de la muestra. Cabe recalcar que en el total de datos, la mayor cantidad de individuos morosos están con un seguro activo. Podemos determinar, en esta muestra, que el estado del seguro no exhibe una conexión notable con la situación de morosidad.

## Gráfico INDICADOR.EXTRANJERO-INDICADOR_MOROSO
moras %>%
  count(INDICADOR.EXTRANJERO, INDICADOR_MOROSO) %>%
  group_by(INDICADOR.EXTRANJERO) %>%
  mutate(pct = n / sum(n) * 100) %>%
  ggplot(aes(x = INDICADOR.EXTRANJERO, y = pct, fill = INDICADOR_MOROSO)) +
  geom_col(position = "fill") +
  labs(
    title = "Relación entre INDICADOR.EXTRANJERO y Morosidad",
    x = "Categoría",
    y = "Porcentaje",
    fill = "Moroso"
  )
### Según el gráfico relacionado a la nacionalidad, se puede observar que tanto los individuos nacionales como los individuos internacionales, el porcentaje de personas morosas es bastante baja, de hecho no alcanzan ni el 20% de la muestra. Cabe recalcar que en el total de datos, la mayor cantidad de individuos morosos son nacionales. Podemos determinar, en esta muestra, que la nacionalidad no exhibe una relación notable con la situación de morosidad.

```

# Pregunta 8
```{r}
## Rangos para SALARIO
moras <- moras %>%
  mutate(
    Rango_SALARIO = case_when(
      SALARIO_IMPUTADO < 300000 ~ "1) 0-300k",
      SALARIO_IMPUTADO >= 300000 & SALARIO_IMPUTADO < 600000 ~ "2) 300k-600k",
      SALARIO_IMPUTADO >= 600000 & SALARIO_IMPUTADO < 900000 ~ "3) 600k-900k",
      SALARIO_IMPUTADO >= 900000 & SALARIO_IMPUTADO < 1200000 ~ "4) 900k-1200k",
      TRUE ~ "5) 1200k+"
    ),
    Rango_EDAD = case_when(
      EDAD_IMPUTADO <= 25 ~ "1) 18-25",
      SALARIO_IMPUTADO > 25 & SALARIO_IMPUTADO <= 35 ~ "2) 25-35",
      SALARIO_IMPUTADO > 35 & SALARIO_IMPUTADO <= 45 ~ "3) 35-45",
      SALARIO_IMPUTADO > 45 & SALARIO_IMPUTADO <= 55 ~ "4) 45-55",
      TRUE ~ "5) 56+"
    )
  )

## Gráfico Salarios-Morosidad
moras %>%
  count(Rango_SALARIO, INDICADOR_MOROSO) %>%
  group_by(Rango_SALARIO) %>%
  ggplot(aes(x = Rango_SALARIO, y = n, fill = INDICADOR_MOROSO)) +
  geom_col(position = "dodge") +
  labs(
    title = "Relación entre Rango_SALARIO y Morosidad",
    x = "Categoría",
    y = "Cantidad",
    fill = "Moroso"
  )
### Observamos que el rango que posee la mayor cantidad de individuos morosos son los que su salario está comprendido entre 300k y 600k. Sin embrago, este mismo rango posee las mayor conatidad de individuos que no poseen morosidades.

## Gráfico Salarios-Morosidad
moras %>%
  count(Rango_EDAD, INDICADOR_MOROSO) %>%
  group_by(Rango_EDAD) %>%
  ggplot(aes(x = Rango_EDAD, y = n, fill = INDICADOR_MOROSO)) +
  geom_col(position = "dodge") +
  labs(
    title = "Relación entre Rango_EDAD y Morosidad",
    x = "Categoría",
    y = "Cantidad",
    fill = "Moroso"
  )
### Observamos que el rango que posee la mayor cantidad de individuos morosos son los que su edad está comprendido entre 36 y 45 años. Observe también que el rango que posee la mayor cantidad de individuos sin morosidades está comprendido entre las edades de 26-35 años.
```

# Pregunta 10
```{r}
library(rpart)
library(rpart.plot)
## Mejora de Categorías
moras <- moras %>%
  mutate(
    TIPO_ASEGURAMIENTO = case_when(
      TIPO_ASEGURAMIENTO == "ASALARIADO" ~ "ASAL",
      TIPO_ASEGURAMIENTO == "PENSIONADOS EN SU PROPIO SISTEMA" ~ "PESPS",
      TIPO_ASEGURAMIENTO == "ASEGURADO VOLUNTARIO" ~ "ASVOL",
      TIPO_ASEGURAMIENTO == "CONVENIOS ESPECIALES DE ASEGURADOS VOLUNTARIOS" ~ "CEDAV",
      TIPO_ASEGURAMIENTO == "CONVENIOS ESPECIALES DE TRABAJADORES INDEPENDIENTES" ~ "CEDTI",
      TIPO_ASEGURAMIENTO == "TRABAJADOR INDEPENDIENTE" ~ "TI",
      TRUE ~ TIPO_ASEGURAMIENTO
    )
  )

## Gráfico 
tree <- rpart(INDICADOR_MOROSO~., data = moras)
rpart.plot(tree)
```
### Respuesta
Se muestran diversas ramas o casos en donde se tiene a la mayoría de la población y se van filtrando si son morosos o no, de esta manera se puede ver en qué sectores se concentran más dicha población, para así, poder definir de mejor manera a que sector se le puede proporcionar un seguro.
